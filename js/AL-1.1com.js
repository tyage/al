/*
 * AL JavaScript Library v1.1
 * http://tyage.sakura.ne.jp/lib/js/AL/
 *
 * Copyright (c) 2009 チャゲ
 */
 AL=function(){var d=[],f=[],g=[],h={up:false,down:false,left:false,right:false,space:false},j={timer:50,keyno:{37:"left",38:"up",39:"right",40:"down",32:"space"},window:{width:750,height:500,bound:{top:0.5,right:0.5,bottom:0.5,left:0.5}},scroll:{top:0,right:0,bottom:0,left:0},loop:{x:false,y:false}},k={chara:{x:"rand",y:"rand",width:32,height:32,jumpRate:20,limit:-1,baseSpeed:{x:1,y:30,gx:0,gy:2,rx:1/2,ry:1/2},bound:{top:1/2,right:1/2,bottom:1/2,left:1/2},isBlockable:["top","right","bottom","left"],isMovable:true},link:{x:"rand",y:"rand",isBlockable:["top","right","bottom","left"]},block:{type:"block",x:"rand",y:"rand",bound:{top:1/2,right:1/2,bottom:1/2,left:1/2},isBlockable:["top","right","bottom","left"]}},l={room:null,blocks:null,links:null,charas:null,help:null};var m=function(b){this.no=d.length;this.x=this.y=this.width=this.height=this.link=this.jumpRate=this.limit=this.string=null;this.isMovable=this.isDeleted=this.isControlable=this.isTreadable=this.isDeletable=false;this.baseSpeed={x:0,y:0,gx:0,gy:0,rx:0,ry:0};this.maxSpeed={x:0,y:0};this.speed={x:0,y:0};this.bound={top:0,right:0,bottom:0,left:0};this.img={now:null,stop:null,up:null,right:null,right2:null,down:null,left:null,left2:null,uleft:null,uright:null,dleft:null,dright:null,bleft:null,bright:null,tleft:null,tright:null};this.isBlocked={up:false,right:false,down:false,left:false};this.isBlockable=[];for(var c in k.chara){this[c]=(typeof k.chara[c]=="object"?u(this[c],k.chara[c]):k.chara[c])}for(var c in b){this[c]=(typeof b[c]=="object"?u(this[c],b[c]):b[c])}if(this.x=="rand")this.x=Math.floor(Math.random()*j.window.width);if(this.y=="rand")this.y=Math.floor(Math.random()*j.window.height);this.oldx=this.x;this.oldy=this.y;if(this.img.stop){this.elem=document.createElement("img");this.elem.setAttribute("src",this.img.stop);this.img.now=this.img.stop}else{this.elem=document.createElement("div");this.elem.innerHTML=this.string||""}if(this.isDeletable){t(this.elem,"mousedown",function(e,a){d[a.getAttribute("no")].isDeleted=true;l.room.removeChild(a)})}this.elem.setAttribute("class","ALchara");this.elem.setAttribute("no",this.no);this.elem.style.width=this.width+"px";this.elem.style.height=this.height+"px";this.reload();l.room.appendChild(this.elem)};m.prototype.move=function(){if(--this.limit==0)l.room.removeChild(this.elem);if(this.isDeleted)return false;this.oldsx=this.speed.x;this.oldsy=this.speed.y;if(this.isMovable){if(this.isControlable){this.speed.x+=(h.right?this.baseSpeed.x:0)-(h.left?this.baseSpeed.x:0);this.speed.y+=(h.down?this.baseSpeed.gy:0);if(h.up&&this.isBlocked.down)this.speed.y=-this.baseSpeed.y}else{this.speed.x+=(Math.floor(Math.random()*this.baseSpeed.x+1/2-this.baseSpeed.x/2));if(this.isBlocked.down&&Math.random()*this.jumpRate<1)this.speed.y=-this.baseSpeed.y}}if(this.speed.x>0)this.speed.x-=this.baseSpeed.rx;if(this.speed.x<0)this.speed.x+=this.baseSpeed.rx;if(this.speed.y>0)this.speed.y-=this.baseSpeed.ry;if(this.speed.y<0)this.speed.y+=this.baseSpeed.ry;this.speed.x+=this.baseSpeed.gx;this.speed.y+=this.baseSpeed.gy;if(this.maxSpeed.x>0&&Math.abs(this.speed.x)>this.maxSpeed.x)this.speed.x=this.speed.x>0?this.maxSpeed.x:-this.maxSpeed.x;if(this.maxSpeed.y>0&&Math.abs(this.speed.y)>this.maxSpeed.y)this.speed.y=this.speed.y>0?this.maxSpeed.y:-this.maxSpeed.y;this.x+=this.speed.x;this.y+=this.speed.y;this.block();if(this.isControlable)this.CheckLick();this.ChangeImage();this.reload()};m.prototype.reload=function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.oldx=this.x;this.oldy=this.y;this.elem.style.left=this.x+"px";this.elem.style.top=this.y+"px"};m.prototype.block=function(){this.isBlocked={up:false,right:false,down:false,left:false};for(var i=f.length;i>0;i--){var a=f[i-1];var b=this.CheckBlock(a);if(b.down){this.x+=a.scroll.top;this.y=a.y-this.height;this.speed.y*=-a.bound.top}else if(b.up){this.x+=a.scroll.bottom;this.y=a.y+a.height;this.speed.y*=-a.bound.bottom}else if(b.left){this.x=a.x-this.width;this.y+=a.scroll.right;this.speed.x*=-a.bound.right}else if(b.right){this.x=a.x+a.width;this.y+=a.scroll.left;this.speed.x*=-a.bound.left}}for(var i=d.length;i>0;i--){var c=d[i-1];if(i-1==this.no||c.isDeleted)continue;var b=this.CheckBlock(c);if(b.down){if(c.isTreadable){d[i-1].isDeleted=true;d[i-1].limit=10;img=(this.difx<0?c.img.tleft:c.img.tright);if(img)d[i-1].elem.setAttribute("src",img)}d[i-1].speed.y+=this.speed.y;this.y=c.y-this.height;this.speed.y*=-c.bound.top}else if(b.up){d[i-1].speed.y+=this.speed.y;this.y=c.y+c.height;this.speed.y*=-c.bound.bottom}else if(b.left){d[i-1].speed.x+=this.speed.x;this.x=c.x-this.width;this.speed.x*=-c.bound.right}else if(b.right){d[i-1].speed.x+=this.speed.x;this.x=c.x+c.width;this.speed.x*=-c.bound.left}}if(this.x+this.width>j.window.width){this.isBlocked.right=true;if(j.loop.x){this.x=0;this.oldx=this.x}else{this.x=j.window.width-this.width;this.speed.x*=-j.window.bound.right}this.y+=this.isBlocked.down||this.isBlocked.up?0:j.scroll.right}else if(this.x<0){this.isBlocked.left=true;if(j.loop.x){this.x=j.window.width-this.width;this.oldx=this.x}else{this.x=0;this.speed.x*=-j.window.bound.left}this.y+=this.isBlocked.down||this.isBlocked.up?0:j.scroll.left}if(this.y<0){this.isBlocked.up=true;if(j.loop.y){this.y=j.window.height-this.height;this.oldy=this.y}else{this.y=0;this.speed.y*=-j.window.bound.top}this.x+=(j.scroll.top<0&&!this.isBlocked.left)||(j.scroll.top>0&&!this.isBlocked.right)?j.scroll.top:0}else if(this.y+this.height>j.window.height){this.isBlocked.down=true;if(j.loop.y){this.y=0;this.oldy=this.y}else{this.y=j.window.height-this.height;this.speed.y*=-j.window.bound.bottom}this.x+=(j.scroll.bottom<0&&!this.isBlocked.left)||(j.scroll.bottom>0&&!this.isBlocked.right)?j.scroll.bottom:0}};m.prototype.CheckLick=function(){if(this.link!=null){if(h.space){window.location=this.link.href;m.prototype.move=function(){}}if(!this.isTouch(this.link)){this.link=null;l.help.style.display="none"}}else{for(var i=g.length;i>0;i--){var a=g[i-1];if(this.isTouch(a)){this.link=a;l.help.style.display="block";break}}}l.help.style.left=(this.x+this.width)+"px";l.help.style.top=(this.y+this.height)+"px"};m.prototype.ChangeImage=function(){var a=null;this.difx=Math.floor(this.x-this.oldx);this.dify=Math.floor(this.y-this.oldy);this.difsx=Math.floor(this.speed.x-this.oldsx);this.difsy=Math.floor(this.speed.y-this.oldsy);if(this.dify<0){if(this.difx>0)a=this.img.uright;else if(this.difx<0)a=this.img.uleft;else a=this.img.up}else if(this.dify>0){if(this.difx>0)a=this.img.dright;else if(this.difx<0)a=this.img.dleft;else a=this.img.down}else{if(this.difx>0)a=(this.difsx<0?this.img.bright:(this.img.now==this.img.right?this.img.right2:this.img.right));else if(this.difx<0)a=(this.difsx<0?(this.img.now==this.img.left?this.img.left2:this.img.left):this.img.bleft);else a=this.img.stop}if(a&&a!=this.img.now){this.img.now=a;this.elem.setAttribute("src",a)}};m.prototype.CheckBlock=function(a){var b={up:false,right:false,down:false,left:false};var c={top:false,right:false,bottom:false,left:false};if(a.isBlockable){for(i=a.isBlockable.length;i>0;i--){c[a.isBlockable[i-1]]=true}}if(this.x+this.width>=a.x&&this.x<=a.x+a.width){if(c.top&&this.oldy+this.height<=a.oldy&&this.y+this.height>=a.y){this.isBlocked.down=true;b.down=true}else if(c.bottom&&this.oldy>=a.oldy+a.height&&this.y<=a.y+a.height){this.isBlocked.up=true;b.up=true}}if(this.y+this.height>=a.y&&this.y<=a.y+a.height){if(c.right&&this.oldx+this.width<=a.oldx&&this.x+this.width>=a.x){this.isBlocked.left=true;b.left=true}else if(c.left&&this.oldx>=a.oldx+a.width&&this.x<=a.x+a.width){this.isBlocked.right=true;b.right=true}}return b}m.prototype.isTouch=function(a){return(Math.abs((this.x+this.width/2)-(a.x+a.width/2))this.max.x){this.x=this.max.x;if(this.type=="elevator")this.speed.x*=-1}if(this.max.y&&this.y>this.max.y){this.y=this.max.y;if(this.type=="elevator")this.speed.y*=-1}if(this.min.x&&this.x0;i--)f[i-1].move();for(var i=d.length;i>0;i--)d[i-1].move()},j.timer)}function r(e){if(document.all)return event.keyCode;else if(document.getElementById)return(e.keyCode)?e.keyCode:e.charCode;else if(document.layers)return e.which}function s(e){try{if(!e.preventDefault)window.event.returnValue=false;else e.preventDefault()}catch(e){}}function t(a,b,c){if(a.addEventListener)a.addEventListener(b,function(e){c(e,this)},false);else if(a.attachEvent)a.attachEvent("on"+b,function(){c(null,event.srcElement)});else a["on"+b]=c}function u(a,b){for(var c in b){a[c]=(typeof b[c]=="object"?u(a[c],b[c]):b[c])}return a}return{key:h,ini:j,def:k,charas:d,blocks:f,links:g,elems:l,chara:m,link:n,block:o,set:p,start:q}}();